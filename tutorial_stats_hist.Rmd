---
title: 'CLIMARK Tutorial: Statistics and Histograms'
author: "Victoria Scholl"
date: "6/19/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      message=FALSE,
                      warning=FALSE,
                      results = 'hide')
```

# Introduction

# Code

## Install / load R packages

First, install the aWhere R packages. 

```{r install_aWhere_packages, eval=FALSE}
# install aWhere R packages
library(devtools)
devtools::install_github("aWhereAPI/aWhere-R-Library")
devtools::install_github("aWhereAPI/aWhere-R-ChartLibrary")
```

Load the R packages that contain functions used in this script. 

```{r load_packages}
library(dplyr)
library(aWhereAPI)
library(aWhereCharts)
```

## Define input files and parameters

Define your working directory. This is the place on your computer where your input files are located for this tutorial, and it is also where the output files will be written. Instead of typing out the entire path to every file that we need ("absolute" paths), you can just use their filenames or locations within this working directory ("relative" paths) since we are setting this working directory as our starting point for the rest of the tutorial. 

```{r set.wd}
# define your working directory - where input files are located and outputs will be saved
working.dir <- "~/Documents/aWhere/"

# set the working directory
setwd(working.dir)
```

Use the *source* function to load R functions that are located on your local machine. For this tutorial, there are a few functions within the *supporting_functions.R* file. 

```{r load.functions}
# load external R functions in local file
source("supporting_functions.R")
```

Specify the weather data directory and file name. 

```{r}
# specify the weather data directory and file name
weather.dir <- "climark_work_csvs/" 
weather.name <- "180609_past30.csv"
```

Specify the template data filename containing the geographic location data.

```{r}
# define template data filename
template.file <- "CLIMARKonlyWardTemplate.csv"
```

If you want to write the histogram plots to image files, set *write.hist* to TRUE. 

```{r}
# write histograms to image files 
write.hist = TRUE
```

To select subarea(s) of interest, list their names in this vector. For now, these subareas are limited to ward names. To generate a forecast for the entire region instead, set *subarea.select* to "ENTIRE_REGION". 

```{r}
subarea.select <- "KARARE" 
subarea.select <- c("KARARE", "GOLBO")
subarea.select <- "ENTIRE_REGION"
```

Define the bin ranges and increments to create tabular summaries of histogram data.

```{r}
# precipitation
bins.precip <- c(seq(from = 0, to = 300, by = 5), Inf) 

# P/PET
bins.ppet <- c(0, 0.4, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2, 1.4, 1.6, 2.0, Inf)   
```


## Processing steps

Read the weather data.

```{r}
# combine the directory and file name
weather.file <- paste(working.dir, weather.dir, weather.name, sep="")

# read the weather data 
weather.df <- read.csv(weather.file)
```

Read the template data. Filter the data to keep only the grid cells within the subarea of interest. Merge the weather and template data by their location ID's into a single data frame. 

```{r}
# read the template data. remove columns that are not necessary.
template.df <- read.csv(paste0(working.dir,template.file)) %>% 
  dplyr::select( -c(shapewkt, longitude, latitude ))

# filter weather data for only the grid locations within the template data 
get.wards.area <- weather.df %>% 
  dplyr::filter(locationid %in% template.df$locationid)

# merge the weather data with and template data (wards/constituen)
weather.template.df <- merge(get.wards.area, 
                          template.df, by = "locationid")
```

Let's take a look at the combined data set. 

```{r results=TRUE}
head(weather.template.df %>% 
       dplyr::select(locationid, WARD_NAME, latitude, longitude, CSUMPRE, CPOVRPR))
```

Write the combined data set to a .csv file. 

```{r}
# construct output filename for weather + template data
weather.template.df.file <- paste("weather+template",
                                  weather.name,
                                  sep = "_")

# write the combined weather and template data to .csv file
write.csv(weather.template.df, 
          file = weather.template.df.file)
```

Filter the data set for subarea(s) of interest and write this clipped data 
set to file. It can become a template for pulling data from the aWhere API.

```{r}
if (!identical(subarea.select, "ENTIRE_REGION")){ 
  
  weather.template.df <- weather.template.df %>% 
    dplyr::filter(WARD_NAME %in% subarea.select) 
  
  write.csv(weather.template.df, file = paste("weather+template_clip_",
                                              weather.name,
                                              sep = "_"))
} 
```

Let's take a look at the combined data set after the subarea filtering. If we are using the "ENTIRE_REGION", it will look the same as before. If we are restricting the data set to a ward or multiple wards, the "WARD_NAME" column will have those restricted values.

```{r results=TRUE}
head(weather.template.df %>% 
       dplyr::select(locationid, latitude, longitude, CSUMPRE, CPOVRPR, WARD_NAME))
```

## Calculate statistics 

For each ward in the data set, let's calculate some statistics such as the mean, max, and standard deviation for selected weather variables. We will calculate these same statistics across the entire CLIMARK region as well, and join these results together for comparison. The number of grid cells per subarea is calculated as well. 

```{r}
# calculate stats across subareas
subarea.stats <- weather.template.df %>%
  dplyr::group_by(WARD_NAME) %>% 
  dplyr::summarise(avg_CSUMPRE = mean(CSUMPRE),
                   max_CSUMPRE = max(CSUMPRE),
                   sd_CSUMPRE = sd(CSUMPRE),
                   avg_LTNsumPre = mean(LTNSUMP),
                   max_LTNsumPre = max(LTNSUMP),
                   sd_LTNsumPre = sd(LTNSUMP),
                   avg_D_CLTNSUMPRE = mean(DFLTSUM),
                   max_D_CLTNSUMPRE = max(DFLTSUM),
                   sd_D_CLTNSUMPRE = sd(DFLTSUM),
                   avg_CP_PET = mean(CPOVRPR),
                   max_CP_PET = max(CPOVRPR),
                   sd_CP_PET = sd(CPOVRPR),
                   avg_LTNP_PET = mean(LTNASPO),
                   max_LTNP_PET = max(LTNASPO),
                   sd_LTNPPET = sd(LTNASPO),
                   avg_D_CLTNP_PET = mean(DFLTPVP),
                   max_D_CLTNP_PET = max(DFLTPVP),
                   sd_D_CLTNP_PET = sd(DFLTPVP),
                   avg_CAvgMinT = mean(CAvgMinT),
                   max_CAvgMinT = max(CAvgMinT),
                   sd_CAvgMinT = sd(CAvgMinT),
                   avg_CAvgMaxT = mean(CAvgMaxT),
                   max_CAvgMaxT = max(CAvgMaxT),
                   sd_CAvgMaxT = sd(CAvgMaxT),
                   n_grids = n())

# calculate the stats across the entire region as a single entry in the table
# this serves as a summary across the entire region
region.stats <- weather.template.df %>%
  dplyr::summarise(avg_CSUMPRE = mean(CSUMPRE),
                   max_CSUMPRE = max(CSUMPRE),
                   sd_CSUMPRE = sd(CSUMPRE),
                   avg_LTNsumPre = mean(LTNSUMP),
                   max_LTNsumPre = max(LTNSUMP),
                   sd_LTNsumPre = sd(LTNSUMP),
                   avg_D_CLTNSUMPRE = mean(DFLTSUM),
                   max_D_CLTNSUMPRE = max(DFLTSUM),
                   sd_D_CLTNSUMPRE = sd(DFLTSUM),
                   avg_CP_PET = mean(CPOVRPR),
                   max_CP_PET = max(CPOVRPR),
                   sd_CP_PET = sd(CPOVRPR),
                   avg_LTNP_PET = mean(LTNASPO),
                   max_LTNP_PET = max(LTNASPO),
                   sd_LTNPPET = sd(LTNASPO),
                   avg_D_CLTNP_PET = mean(DFLTPVP),
                   max_D_CLTNP_PET = max(DFLTPVP),
                   sd_D_CLTNP_PET = sd(DFLTPVP),
                   avg_CAvgMinT = mean(CAvgMinT),
                   max_CAvgMinT = max(CAvgMinT),
                   sd_CAvgMinT = sd(CAvgMinT),
                   avg_CAvgMaxT = mean(CAvgMaxT),
                   max_CAvgMaxT = max(CAvgMaxT),
                   sd_CAvgMaxT = sd(CAvgMaxT),
                   n_grids = n()) %>% 
      dplyr::mutate(WARD_NAME = "ENTIRE REGION") %>%
      dplyr::select(WARD_NAME, n_grids, everything())

# combine the ward-specific stats with the overall region calculation
stats.out <- rbind(region.stats,
                   subarea.stats)
```

Let's take a look at the statistics data.

```{r results=TRUE}
# take a look at the statistics data 
head(stats.out[,1:5], n = 10)
```

Write these statistics to a .csv file.

```{r}
# write ward statistics to file 
write.csv(stats.out,
          paste("stats_by_subarea",
                weather.name,
                sep="_"))
```


# Histograms 

Visualize the data using the **generateaWhereHistogram** function within the **aWhereCharts** package.



